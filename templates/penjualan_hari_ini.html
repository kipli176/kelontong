<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>Laporan Penjualan ‚Äî Kasir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/static/css/style.css" rel="stylesheet">
</head>

<body class="h-screen w-screen bg-slate-100 flex flex-col" data-toko-id="{{ toko.id }}" data-toko-nama="{{ toko.nama }}"
  data-toko-alamat="{{ toko.alamat }}">

  <!-- Header Navigasi (konsisten) -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <div class="text-xl font-bold">üìÑ Laporan Penjualan</div>
    <nav class="flex gap-4 text-sm">
      <a href="{{ url_for('kasir') }}" class="rounded py-1 px-3 hover:bg-emerald-600">üè† Kasir</a>
      <a href="{{ url_for('penjualan') }}" class="bg-slate-200 rounded py-1 px-3 text-slate-600 hover:bg-emerald-600">üìÑ Laporan</a>
      <button id="btnFullscreen" class="border rounded ml-auto px-1 py-1 rounded hover:bg-slate-600" title="Fullscreen">
        üî≤
      </button>
    </nav>
  </header>

  <!-- Main -->
  <main class="flex-1 p-3 flex flex-col gap-3 overflow-hidden">

    <!-- Tabs -->
    <section class="bg-white rounded shadow-sm p-3 flex flex-col gap-3 overflow-hidden">
      <div class="flex gap-1 border-b">
        <button id="tabTransaksi" class="px-3 py-2 rounded-t bg-white border border-b-0">Transaksi</button>
        <button id="tabDetail" class="px-3 py-2 rounded-t bg-slate-100 text-slate-600 border">Detail Barang</button>
        <button id="tabLaporan" class="px-3 py-2 rounded-t bg-slate-100 text-slate-600 border">Laporan</button>
      </div>

      <!-- ===================== -->
      <!-- TAB TRANSAKSI (lama) -->
      <!-- ===================== -->
      <div id="paneTransaksi" class="border p-4 rounded-b bg-white">              
        <div class="flex justify-between mb-2 items-center">
          <h3 class="font-semibold">
            Transaksi Hari Ini
            <small class="text-slate-600">
              ({{ keterangan_tanggal }})
            </small>
          </h3>
          <div class="flex gap-2 items-center">
            <form method="get" class="flex gap-1 items-center">
              <label class="text-sm text-slate-600">Periode:</label>
              <input type="hidden" name="tab" id="inputTab" value="transaksi">
              <label class="text-sm text-slate-600">Dari</label>
              <input type="date" name="start" value="{{ start }}" class="border rounded px-3 py-2 text-sm">
              <label class="text-sm text-slate-600">Hingga</label>
              <input type="date" name="end" value="{{ end }}" class="border rounded px-3 py-2 text-sm">
              <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Terapkan</button>
            </form>
            <button onclick="window.open('{{ url_for('print_transaksi_hari_ini', start=start, end=end) }}','_blank')"
                    class="px-3 py-2 bg-slate-600 text-white rounded text-sm">üñ® Print</button>
            <a href="{{ url_for('export_transaksi_hari_ini_xlsx', start=start, end=end) }}"
              class="px-3 py-2 bg-emerald-600 text-white rounded text-sm">‚¨áÔ∏è Export Excel</a>
          </div>
        </div>
        <div class="border rounded overflow-auto max-h-[60vh]">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Waktu</th>
                <th class="p-2 border">No Transaksi</th>
                <th class="p-2 border">Pembeli</th>
                <th class="p-2 border">Metode</th>
                <th class="p-2 border text-right">Item</th>
                <th class="p-2 border text-right">Total</th>
                <th class="p-2 border text-right">Laba</th>
                <th class="p-2 border">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbTransaksi">
              {% set ns = namespace(gtotal=0, glaba=0, gitem=0) %}
              {% for id, tgl, tx8, nama, hp, metode, total, laba, jml_item in rows %}
              {% set ns.gtotal = ns.gtotal + (total or 0) %}
              {% set ns.glaba = ns.glaba + (laba or 0) %}
              {% set ns.gitem = ns.gitem + (jml_item or 0) %}
              <tr class="odd:bg-white even:bg-slate-50">
                <td class="p-2 border whitespace-nowrap">{{ tgl.strftime("%d-%m-%Y %H:%M:%S") }}</td>
                <td class="p-2 border font-mono">TX-{{ tx8|upper }}</td>
                <td class="p-2 border">{{ nama or "-" }}{% if hp %} ‚Äî {{ hp }}{% endif %}</td>
                <td class="p-2 border">{{ metode or "-" }}</td>
                <td class="p-2 border text-right">{{ jml_item or 0 }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(total or 0) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
                <td class="p-2 border text-center">
                  <div class="items-center gap-2">
                    <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs"
                      onclick="printById({{ id }}, { nama: document.body.dataset.tokoNama || '', alamat: document.body.dataset.tokoAlamat || '' })">üßæ Cetak Ulang</button>
                    {% if hp %}
                    <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs"
                      onclick="waById({{ id }}, '{{ (nama or '')|e }}', '{{ hp|e }}', { nama: document.body.dataset.tokoNama || '', alamat: document.body.dataset.tokoAlamat || '' })">üì≤ Kirim WA</button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td class="p-4 text-center text-slate-500" colspan="8">Belum ada transaksi hari ini.</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-slate-200 font-semibold">
              <tr>
                <td colspan="4" class="text-right">TOTAL</td>
                <td class="p-2 border text-right">{{ ns.gitem }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(ns.gtotal) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(ns.glaba) }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- ======================= -->
      <!-- TAB DETAIL BARANG (baru) -->
      <!-- ======================= -->
      <div id="paneDetail" class="hidden border p-4 rounded-b bg-white">
        <div class="flex justify-between mb-2 items-center">
          <h3 class="font-semibold">
            Barang Keluar Hari Ini
            <small class="text-slate-600">
              ({{ keterangan_tanggal }})
            </small>
          </h3>
          <div class="flex gap-2 items-center">
            <form method="get" class="flex gap-1 items-center">
              <label class="text-sm text-slate-600">Periode:</label>
              <input type="hidden" name="tab" id="inputTab" value="detail">
              <label class="text-sm text-slate-600">Dari</label>
              <input type="date" name="start" value="{{ start }}" class="border rounded px-3 py-2 text-sm">
              <label class="text-sm text-slate-600">Hingga</label>
              <input type="date" name="end" value="{{ end }}" class="border rounded px-3 py-2 text-sm">
              <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Terapkan</button>
            </form>
            <button onclick="window.open('{{ url_for('print_detail_hari_ini', start=start, end=end) }}','_blank')"
                    class="px-3 py-2 bg-slate-600 text-white rounded text-sm">üñ® Print</button>
            <a href="{{ url_for('export_detail_hari_ini_xlsx', start=start, end=end) }}"
              class="px-3 py-2 bg-emerald-600 text-white rounded text-sm">‚¨áÔ∏è Export Excel</a>
          </div>
        </div>

        <div class="border rounded overflow-auto max-h-[60vh]">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Barang</th>
                <th class="p-2 border text-right">Harga Beli</th>
                <th class="p-2 border text-right">Harga Jual</th>
                <th class="p-2 border text-right">Qty</th>
                <th class="p-2 border text-right">Total</th>
                <th class="p-2 border text-right">Laba</th>
                <th class="p-2 border">Detail</th>
              </tr>
            </thead>
            <tbody>
              {% set nd = namespace(gtotal=0, glaba=0, gqty=0) %}
              {% for barcode, item, hb, hj, qty, total, laba in detail_rows %}
              {% set nd.gtotal = nd.gtotal + (total or 0) %}
              {% set nd.glaba  = nd.glaba + (laba or 0) %}
              {% set nd.gqty   = nd.gqty + (qty or 0) %}
              <tr class="odd:bg-white even:bg-slate-50">
                <td class="p-2 border">{{ item }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(hb or 0) }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(hj or 0) }}</td>
                <td class="p-2 border text-right">{{ qty }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(total or 0) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
                <td class="p-2 border text-center">
                  <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs"
                          onclick="showDetailBarang('{{ barcode }}', {{ hj }}, '{{ item }}')">üëÅ Detail</button>
                </td>
              </tr>
              {% else %}
              <tr>
                <td class="p-4 text-center text-slate-500" colspan="6">Belum ada barang keluar hari ini.</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-slate-200 font-semibold">
              <tr>
                <td class="p-2 border" colspan="2"></td> 
                <td class="p-2 border text-right" colspan="1">TOTAL</td>
                <td class="p-2 border text-right">{{ nd.gqty }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(nd.gtotal) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(nd.glaba) }}</td>
                <td class="p-2 border"></td> 
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div id="paneLaporan" class="hidden border p-4 rounded-b bg-white">
        <div class="flex justify-between mb-2 items-center">
          <h3 class="font-semibold">
            Laporan Penjualan
            <small class="text-slate-600">({{ keterangan_tanggal }})</small>
          </h3>
          <div class="flex gap-2 items-center">
            <form method="get" class="flex gap-1 items-center">
              <label class="text-sm text-slate-600">Periode:</label>
              <input type="hidden" name="tab" id="inputTab" value="laporan">
              <label class="text-sm text-slate-600">Dari</label>
              <input type="date" name="start" value="{{ start }}" class="border rounded px-3 py-2 text-sm">
              <label class="text-sm text-slate-600">Hingga</label>
              <input type="date" name="end" value="{{ end }}" class="border rounded px-3 py-2 text-sm">
              <button type="submit" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Terapkan</button>
            </form> 
          </div>
        </div>

        <!-- Ringkasan KPI -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
          <div class="p-4 bg-blue-100 rounded text-center">
            <div class="text-xl font-bold">{{ total_transaksi }}</div>
            <div class="text-slate-600">Transaksi</div>
          </div>
          <div class="p-4 bg-green-100 rounded text-center">
            <div class="text-xl font-bold">{{ total_item }}</div>
            <div class="text-slate-600">Item Terjual</div>
          </div>
          <div class="p-4 bg-yellow-100 rounded text-center">
            <div class="text-xl font-bold">Rp {{ "{:,.0f}".format(total_omzet or 0) }}</div>
            <div class="text-slate-600">Omzet</div>
          </div>
          <div class="p-4 bg-emerald-100 rounded text-center">
            <div class="text-xl font-bold">Rp {{ "{:,.0f}".format(total_laba or 0) }}</div>
            <div class="text-slate-600">Laba</div>
          </div>
        </div>

        <!-- Tabel Ringkasan per Hari -->
        <h4 class="font-semibold mb-2">Ringkasan Harian</h4>
        <div class="overflow-auto max-h-[60vh] border rounded">
          <table class="w-full text-sm border-collapse">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Tanggal</th>
                <th class="p-2 border text-right">Transaksi</th>
                <th class="p-2 border text-right">Item</th>
                <th class="p-2 border text-right">Omzet</th>
                <th class="p-2 border text-right">Laba</th>
              </tr>
            </thead>
            <tbody>
              {% for tgl, jml_transaksi, jml_item, omzet, laba in ringkasan_rows %}
              <tr>
                <td class="p-2 border">{{ tgl.strftime("%d %B %Y") }}</td>
                <td class="p-2 border text-right">{{ jml_transaksi }}</td>
                <td class="p-2 border text-right">{{ jml_item }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(omzet or 0) }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Barang Terlaris -->
        <h4 class="font-semibold mt-6 mb-2">Top 10 Barang Terlaris</h4>
        <div class="overflow-auto max-h-[60vh] border rounded">
          <table class="w-full text-sm border-collapse">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Barang</th>
                <th class="p-2 border text-right">Qty</th>
                <th class="p-2 border text-right">Omzet</th>
                <th class="p-2 border text-right">Laba</th>
              </tr>
            </thead>
            <tbody>
              {% set ns = namespace(total_qty=0, total_omzet=0, total_laba=0) %}
              {% for barcode, item, qty, omzet, laba in terlaris_rows %}
                <tr>
                  <td class="p-2 border">{{ item }}</td>
                  <td class="p-2 border text-right">{{ qty }}</td>
                  <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(omzet or 0) }}</td>
                  <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
                </tr>
                {% set ns.total_qty = ns.total_qty + (qty or 0) %}
                {% set ns.total_omzet = ns.total_omzet + (omzet or 0) %}
                {% set ns.total_laba = ns.total_laba + (laba or 0) %}
              {% endfor %}
            </tbody>
            <tfoot class="bg-slate-200 font-semibold">
              <tr>
                <td class="p-2 border text-right">TOTAL</td>
                <td class="p-2 border text-right">{{ ns.total_qty }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(ns.total_omzet) }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(ns.total_laba) }}</td>
              </tr>
            </tfoot>
          </table>
        </div>


      </div>


<!-- Modal -->
<div id="modalDetailBarang" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded shadow-lg w-3/4 max-h-[80vh] overflow-auto p-4">
    <h3 id="modalTitleBarang" class="font-semibold mb-3">Detail Pembelian Barang</h3>
    <table class="w-full text-sm border">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-2 border">Waktu</th>
          <th class="p-2 border">Nota</th>
          <th class="p-2 border">Pembeli</th>
          <th class="p-2 border text-right">Qty</th>
        </tr>
      </thead>
      <tbody id="modalBodyDetail"></tbody>
      <tfoot class="bg-slate-200 font-semibold">
        <tr>
          <td colspan="3" class="p-2 border text-right">TOTAL</td>
          <td id="modalTotalQty" class="p-2 border text-right">0</td>
        </tr>
      </tfoot>
    </table>
    <div class="mt-3 text-right">
      <button onclick="closeModal()" class="px-3 py-2 bg-slate-500 text-white rounded">Tutup</button>
    </div>
  </div>
</div>


    </section>
  </main>

  <!-- Footer shortcut (konsisten) -->
  <footer class="bg-slate-200 text-slate-700 text-sm p-2 text-center">
    Shortcut: <kbd class="px-1">F5</kbd> refresh, untuk cetak ulang atau kirim WA, klik tombol pada baris transaksi yang
    diinginkan.
    halaman, <a href="{{ url_for('kasir') }}" class="underline">Kembali ke Kasir</a>
  </footer>
  <script src="/static/js/esc-pos-encoder.umd.min.js"></script>
  <script src="/static/js/ua-parser.min.js"></script>
  <script src="/static/js/nota-utils.js"></script>
  <script src="/static/js/app.js"></script>


<script>
function showDetailBarang(barcode, harga, nama) {
  fetch(`/api/detail-barang/${barcode}/${harga}`)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById("modalBodyDetail");
      const title = document.getElementById("modalTitleBarang");
      const totalCell = document.getElementById("modalTotalQty");

      body.innerHTML = "";
      title.textContent = `Detail Pembelian Barang: ${nama}`;

      let totalQty = 0;
      data.forEach(row => {
        body.innerHTML += `
          <tr>
            <td class="p-2 border">${row.waktu}</td>
            <td class="p-2 border">TX-${row.tx8}</td>
            <td class="p-2 border">${row.pembeli} ${row.no_hp ? "‚Äî "+row.no_hp : ""}</td>
            <td class="p-2 border text-right">${row.qty}</td>
          </tr>`;
        totalQty += row.qty;
      });

      totalCell.textContent = totalQty;
      document.getElementById("modalDetailBarang").classList.remove("hidden");
    });
}

function closeModal(){
  document.getElementById("modalDetailBarang").classList.add("hidden");
}
</script>

<script>
  const tabT = document.getElementById('tabTransaksi');
  const tabD = document.getElementById('tabDetail');
  const tabL = document.getElementById('tabLaporan');

  const paneT = document.getElementById('paneTransaksi');
  const paneD = document.getElementById('paneDetail');
  const paneL = document.getElementById('paneLaporan');

  const inputTab = document.getElementById('inputTab');

  function activate(tab) {
    [tabT, tabD, tabL].forEach(btn => {
      btn.classList.remove('bg-white','border-b-0','text-black');
      btn.classList.add('bg-slate-100','text-slate-600');
    });
    [paneT, paneD, paneL].forEach(pane => pane.classList.add('hidden'));

    if (tab === 'transaksi') {
      tabT.classList.add('bg-white','border-b-0','text-black');
      tabT.classList.remove('bg-slate-100','text-slate-600');
      paneT.classList.remove('hidden');
    } else if (tab === 'detail') {
      tabD.classList.add('bg-white','border-b-0','text-black');
      tabD.classList.remove('bg-slate-100','text-slate-600');
      paneD.classList.remove('hidden');
    } else if (tab === 'laporan') {
      tabL.classList.add('bg-white','border-b-0','text-black');
      tabL.classList.remove('bg-slate-100','text-slate-600');
      paneL.classList.remove('hidden');
    }
  }

  tabT.onclick = () => activate('transaksi');
  tabD.onclick = () => activate('detail');
  tabL.onclick = () => activate('laporan'); 

  // default aktif ‚Üí baca dari query string
  const params = new URLSearchParams(window.location.search);
  const currentTab = params.get('tab') || 'transaksi';
  // default aktif: transaksi
  activate(currentTab);
</script>

  <!-- Script: cetak & WA -->
  <script>
    const fmt = n => "Rp " + (n || 0).toLocaleString('id-ID');

    function doFilter() {
      const q = (document.getElementById('q').value || "").toLowerCase();
      const rows = document.querySelectorAll("#txTable tr");
      rows.forEach(tr => {
        const text = tr.innerText.toLowerCase();
        tr.style.display = text.includes(q) ? "" : "none";
      });
    }
    function resetFilter() {
      document.getElementById('q').value = "";
      doFilter();
    }


    // ===== Wrapper untuk Penjualan Hari Ini =====
    async function printById(id, toko) {
      try {
        const data = await fetchDetail(id); // {header, items}
        const trx = {
          ...data.header,
          items: data.items
        };
        printNota(trx, toko); // ‚úÖ konsisten dengan kasir_script
      } catch (e) {
        alert("Gagal cetak ulang: " + e.message);
      }
    }

    async function waById(id, nama, no_hp, toko) {
      try {
        const data = await fetchDetail(id);

        const number = (no_hp && /^62\d+$/.test(no_hp))
          ? no_hp
          : (data.header.no_hp || "");
        if (!/^62\d+$/.test(number)) {
          alert("Nomor WA tidak valid");
          return;
        }

        const message = generateNotaWA(data.header, data.items, toko);

        const r = await fetch("/api/send-wa", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number, message })
        });
        const js = await r.json();
        if (!r.ok) throw new Error(js.msg || "Gagal kirim WA");
        alert("Pesan WA terkirim ‚úÖ");
      } catch (e) {
        alert("Gagal kirim WA: " + e.message);
      }
    }


  </script>
</body>

</html>