<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>Penjualan Hari Ini ‚Äî Kasir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/static/css/style.css" rel="stylesheet">
</head>

<body class="h-screen w-screen bg-slate-100 flex flex-col" data-toko-id="{{ toko.id }}" data-toko-nama="{{ toko.nama }}"
  data-toko-alamat="{{ toko.alamat }}">

  <!-- Header Navigasi (konsisten) -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <div class="text-xl font-bold">üìÑ Penjualan Hari Ini</div>
    <nav class="flex gap-4 text-sm">
      <a href="{{ url_for('kasir') }}" class="hover:underline">üè† Kasir</a>
      <a href="{{ url_for('penjualan_hari_ini') }}" class="hover:underline font-semibold underline">üìÑ Penjualan Hari
        Ini</a>
      <a href="{{ url_for('laporan') }}" class="hover:underline">üìä Laporan</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="flex-1 p-3 flex flex-col gap-3 overflow-hidden">

    <!-- Tabs -->
    <section class="bg-white rounded shadow-sm p-3 flex flex-col gap-3 overflow-hidden">
      <div class="flex gap-2 mb-3">
        <button id="tabTransaksi" class="px-3 py-2 rounded bg-slate-200">Transaksi</button>
        <button id="tabDetail" class="px-3 py-2 rounded">Detail Barang</button>
        <div class="ml-auto flex gap-2">
          <button id="btnPrint" class="px-3 py-2 bg-slate-600 text-white rounded text-sm">üñ® Print</button>
          <a id="btnExport" href="{{ url_for('export_hari_ini_xlsx') }}"
            class="px-3 py-2 bg-emerald-600 text-white rounded text-sm">‚¨áÔ∏è Export Excel</a>
        </div>
      </div>

      <!-- ===================== -->
      <!-- TAB TRANSAKSI (lama) -->
      <!-- ===================== -->
      <div id="paneTransaksi">
        <div class="border rounded overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Waktu</th>
                <th class="p-2 border">No Transaksi</th>
                <th class="p-2 border">Pembeli</th>
                <th class="p-2 border">Metode</th>
                <th class="p-2 border text-right">Item</th>
                <th class="p-2 border text-right">Total</th>
                <th class="p-2 border text-right">Laba</th>
                <th class="p-2 border">Aksi</th>
              </tr>
            </thead>
            <tbody id="tbTransaksi">
              {% set ns = namespace(gtotal=0, glaba=0, gitem=0) %}
              {% for id, tgl, tx8, nama, hp, metode, total, laba, jml_item in rows %}
              {% set ns.gtotal = ns.gtotal + (total or 0) %}
              {% set ns.glaba  = ns.glaba + (laba or 0) %}
              {% set ns.gitem  = ns.gitem + (jml_item or 0) %}
              <tr class="odd:bg-white even:bg-slate-50">
                <td class="p-2 border whitespace-nowrap">{{ tgl.strftime("%H:%M:%S") }}</td>
                <td class="p-2 border font-mono">TX-{{ tx8|upper }}</td>
                <td class="p-2 border">{{ nama or "-" }}{% if hp %} ‚Äî {{ hp }}{% endif %}</td>
                <td class="p-2 border">{{ metode or "-" }}</td>
                <td class="p-2 border text-right">{{ jml_item or 0 }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(total or 0) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
                <td class="p-2 border">
                  <div class="flex items-center gap-2">
                    <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs"
                            onclick="printById({{ id }}, toko)">üßæ Cetak Ulang</button>
                    {% if hp %}
                    <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs"
                            onclick="waById({{ id }}, '{{ nama|e }}', '{{ hp|e }}', toko)">üì≤ Kirim WA</button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td class="p-4 text-center text-slate-500" colspan="8">Belum ada transaksi hari ini.</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-slate-200 font-semibold">
              <tr>
                <td colspan="4" class="text-right">TOTAL</td>
                <td class="p-2 border text-right">{{ ns.gitem }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(ns.gtotal) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(ns.glaba) }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- ======================= -->
      <!-- TAB DETAIL BARANG (baru) -->
      <!-- ======================= -->
      <div id="paneDetail" class="hidden">
        <div class="border rounded overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-100 sticky top-0">
              <tr>
                <th class="p-2 border">Waktu</th>
                <th class="p-2 border">Nota</th>
                <th class="p-2 border">Pembeli</th>
                <th class="p-2 border">Barang</th>
                <th class="p-2 border text-right">Qty</th>
                <th class="p-2 border text-right">Harga Jual</th>
                <th class="p-2 border text-right">Subtotal</th>
                <th class="p-2 border text-right">Laba</th>
              </tr>
            </thead>
            <tbody id="tbDetail">
              {% set nd = namespace(gtotal=0, glaba=0, gqty=0) %}
              {% for tx8, tgl, pembeli, hp, barcode, item, qty, hj, sub, laba in detail_rows %}
              {% set nd.gtotal = nd.gtotal + (sub or 0) %}
              {% set nd.glaba  = nd.glaba + (laba or 0) %}
              {% set nd.gqty   = nd.gqty + (qty or 0) %}
              <tr class="odd:bg-white even:bg-slate-50">
                <td class="p-2 border">{{ tgl.strftime("%H:%M:%S") }}</td>
                <td class="p-2 border">TX-{{ tx8|upper }}</td>
                <td class="p-2 border">{{ pembeli }}{% if hp %} ‚Äî {{ hp }}{% endif %}</td>
                <td class="p-2 border">{{ item }}</td>
                <td class="p-2 border text-right">{{ qty }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(hj or 0) }}</td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(sub or 0) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
              </tr>
              {% else %}
              <tr>
                <td class="p-4 text-center text-slate-500" colspan="8">Belum ada detail barang hari ini.</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot class="bg-slate-200 font-semibold">
              <tr>
                <td colspan="4" class="text-right">TOTAL</td>
                <td class="p-2 border text-right">{{ nd.gqty }}</td>
                <td></td>
                <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(nd.gtotal) }}</td>
                <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(nd.glaba) }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer shortcut (konsisten) -->
  <footer class="bg-slate-200 text-slate-700 text-sm p-2 text-center">
    Shortcut: <kbd class="px-1">F5</kbd> refresh, untuk cetak ulang atau kirim WA, klik tombol pada baris transaksi yang diinginkan.
    halaman, <a href="{{ url_for('kasir') }}" class="underline">Kembali ke Kasir</a>
  </footer>
  <script src="/static/js/esc-pos-encoder.umd.min.js"></script>
  <script src="/static/js/ua-parser.min.js"></script>
  <script src="/static/js/nota-utils.js"></script>
  <script src="/static/js/app.js"></script>

  
  <script>
  const tabT = document.getElementById('tabTransaksi');
  const tabD = document.getElementById('tabDetail');
  const paneT = document.getElementById('paneTransaksi');
  const paneD = document.getElementById('paneDetail');
  const btnPrint = document.getElementById('btnPrint');
  const btnExport = document.getElementById('btnExport');

  function activate(tab){
    if(tab==='transaksi'){
      paneT.classList.remove('hidden'); paneD.classList.add('hidden');
      tabT.classList.add('bg-slate-200'); tabD.classList.remove('bg-slate-200');
      btnExport.href = "{{ url_for('export_hari_ini_xlsx') }}";
      btnPrint.onclick = ()=>window.print();  // print transaksi
    } else {
      paneD.classList.remove('hidden'); paneT.classList.add('hidden');
      tabD.classList.add('bg-slate-200'); tabT.classList.remove('bg-slate-200');
      btnExport.href = "{{ url_for('export_detail_hari_ini_xlsx') }}";
      btnPrint.onclick = ()=>window.print();  // print detail
    }
  }
  tabT.onclick=()=>activate('transaksi');
  tabD.onclick=()=>activate('detail');
  activate('transaksi');
  </script>
  <!-- Script: cetak & WA -->
  <script>
    const fmt = n => "Rp " + (n || 0).toLocaleString('id-ID');

    function doFilter() {
      const q = (document.getElementById('q').value || "").toLowerCase();
      const rows = document.querySelectorAll("#txTable tr");
      rows.forEach(tr => {
        const text = tr.innerText.toLowerCase();
        tr.style.display = text.includes(q) ? "" : "none";
      });
    }
    function resetFilter() {
      document.getElementById('q').value = "";
      doFilter();
    }


    // ===== Wrapper untuk Penjualan Hari Ini =====
    async function printById(id, toko) {
      try {
        const data = await fetchDetail(id); // {header, items}
        const trx = {
          ...data.header,
          items: data.items
        };
        printNota(trx, toko); // ‚úÖ konsisten dengan kasir_script
      } catch (e) {
        alert("Gagal cetak ulang: " + e.message);
      }
    }

    async function waById(id, nama, no_hp, toko) {
      try {
        const data = await fetchDetail(id);

        const number = (no_hp && /^62\d+$/.test(no_hp))
          ? no_hp
          : (data.header.no_hp || "");
        if (!/^62\d+$/.test(number)) {
          alert("Nomor WA tidak valid");
          return;
        }

        const message = generateNotaWA(data.header, data.items, toko);

        const r = await fetch("/api/send-wa", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number, message })
        });
        const js = await r.json();
        if (!r.ok) throw new Error(js.msg || "Gagal kirim WA");
        alert("Pesan WA terkirim ‚úÖ");
      } catch (e) {
        alert("Gagal kirim WA: " + e.message);
      }
    }
 

  </script>
</body>

</html>