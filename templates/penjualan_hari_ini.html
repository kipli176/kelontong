<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Penjualan Hari Ini ‚Äî Kasir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-screen w-screen bg-slate-100 flex flex-col"  data-toko-id="{{ toko.id }}" data-toko-nama="{{ toko.nama }}" data-toko-alamat="{{ toko.alamat }}">

  <!-- Header Navigasi (konsisten) -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <div class="text-xl font-bold">üìÑ Penjualan Hari Ini</div>
    <nav class="flex gap-4 text-sm">
      <a href="{{ url_for('kasir') }}" class="hover:underline">üè† Kasir</a>
      <a href="{{ url_for('penjualan_hari_ini') }}" class="hover:underline font-semibold underline">üìÑ Penjualan Hari Ini</a>
      <a href="{{ url_for('laporan') }}" class="hover:underline">üìä Laporan</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="flex-1 p-3 flex flex-col gap-3 overflow-hidden">
    <!-- Filter bar -->
    <section class="bg-white rounded shadow-sm p-3 flex items-center gap-2">
      <input id="q" placeholder="üîé Cari pembeli / no HP / No Transaksi (TX-)"
             class="flex-1 border rounded px-3 py-2 text-sm" />
      <button onclick="doFilter()" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Cari</button>
      <button onclick="resetFilter()" class="px-3 py-2 bg-slate-200 rounded text-sm">Reset</button>
    </section>

    <!-- Tabel transaksi -->
    <section class="bg-white rounded shadow-sm p-3 overflow-hidden flex-1 flex flex-col">
      
<div class="flex items-center justify-between mb-2">
  <div class="text-lg font-semibold">Transaksi tanggal: {{ rows[0][1] if rows|length > 0 else '' }}</div>
  <div class="flex items-center gap-2">
    <a href="{{ url_for('export_hari_ini_xlsx') }}" class="px-3 py-2 bg-emerald-600 text-white rounded text-sm">‚¨áÔ∏è Export XLSX</a>
    <!--span class="text-sm text-slate-600">Total transaksi: {{ rows|length }}</span-->
  </div>
</div>

      <div class="border rounded overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 sticky top-0">
            <tr>
              <th class="p-2 border">Waktu</th>
              <th class="p-2 border">No Transaksi</th>
              <th class="p-2 border">Pembeli</th>
              <th class="p-2 border text-right">Total</th>
              <th class="p-2 border text-right">Laba</th>
              <th class="p-2 border">Aksi</th>
            </tr>
          </thead>
          <tbody id="txTable">
  {% set ns = namespace(gtotal=0, glaba=0) %}
            {% for id, tgl, tx8, nama, hp, total, laba in rows %}
    {% set ns.gtotal = ns.gtotal + (total or 0) %}
    {% set ns.glaba = ns.glaba + (laba or 0) %}
            <tr class="odd:bg-white even:bg-slate-50">
              <td class="p-2 border whitespace-nowrap">{{ tgl.strftime("%H:%M:%S") }}</td>
              <td class="p-2 border font-mono">TX-{{ tx8|upper }}</td>
              <td class="p-2 border">{{ nama or "-" }}{% if hp %} ‚Äî {{ hp }}{% endif %}</td>
              <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(total or 0) }}</td>
              <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(laba or 0) }}</td>
              <td class="p-2 border">
                <div class="flex items-center gap-2">
                  <button class="px-2 py-1 bg-emerald-600 text-white rounded text-xs"
                          onclick="printById({{ id }}, {
                              nama: document.body.dataset.tokoNama || '',
                              alamat: document.body.dataset.tokoAlamat || ''
                          })">üßæ Cetak Ulang</button>
                  {% if hp %}
                  <button class="px-2 py-1 bg-blue-600 text-white rounded text-xs"
                          onclick="waById({{ id }}, '{{ (nama or '')|e }}', '{{ hp|e }}', {
                              nama: document.body.dataset.tokoNama || '',
                              alamat: document.body.dataset.tokoAlamat || ''
                          })">üì≤ Kirim WA</button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% else %}
            <tr><td class="p-4 text-center text-slate-500" colspan="6">Belum ada transaksi hari ini.</td></tr>
            {% endfor %}
          </tbody>
<tfoot class="bg-slate-200 font-semibold">
  <tr>
    <td class="p-2 border text-right" colspan="3">TOTAL</td>
    <td class="p-2 border text-right">Rp {{ "{:,.0f}".format(ns.gtotal) }}</td>
    <td class="p-2 border text-right text-emerald-700">Rp {{ "{:,.0f}".format(ns.glaba) }}</td>
    <td class="p-2 border"></td>
  </tr>
</tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Footer shortcut (konsisten) -->
  <footer class="bg-slate-200 text-slate-700 text-sm p-2 text-center">
    Shortcut: <kbd class="px-1">F5</kbd> refresh, <kbd class="px-1">Ctrl</kbd> + <kbd class="px-1">P</kbd> print halaman, <a href="{{ url_for('kasir') }}" class="underline">Kembali ke Kasir</a>
  </footer>

  <!-- Script: cetak & WA -->
  <script>
    const fmt = n => "Rp " + (n||0).toLocaleString('id-ID');

    function doFilter(){
      const q = (document.getElementById('q').value || "").toLowerCase();
      const rows = document.querySelectorAll("#txTable tr");
      rows.forEach(tr=>{
        const text = tr.innerText.toLowerCase();
        tr.style.display = text.includes(q) ? "" : "none";
      });
    }
    function resetFilter(){
      document.getElementById('q').value = "";
      doFilter();
    }
function generateNota(head, items, toko) {
  const total = items.reduce(
    (a, b) => a + (b.qty * b.harga_jual - (b.potongan || 0)),
    0
  );

  // kode TX pakai client_tx_id ‚Üí ambil 8 digit terakhir
  const notaId = "TX-" + ((head.client_tx_id || "").slice(-8).toUpperCase());

  // pakai tanggal dari head.tanggal atau head.tanggal_client
  const tanggalStr = new Date(head.tanggal || head.tanggal_client || Date.now())
    .toLocaleString("id-ID");

  // baris item
  const textLines = items.map(it => {
    const sub = it.qty * it.harga_jual - (it.potongan || 0);
    return `${it.qty}x ${it.nama} @${fmt(it.harga_jual)} = ${fmt(sub)}`;
  });

  // versi teks polos (WA)
  const text = [
    (toko?.nama || "STRUK PENJUALAN"),
    (toko?.alamat || ""),
    `No: ${notaId}`,
    tanggalStr,
    "---------------------------",
    ...textLines,
    "---------------------------",
    `TOTAL    : ${fmt(total)}`,
    `BAYAR    : ${fmt(head.bayar)}`,
    `KEMBALI  : ${fmt(head.kembalian)}`,
    `METODE   : ${head.metode_bayar || ""}`,
    "",
    "Terima Kasih üôè"
  ].filter(Boolean).join("\n");

  // versi HTML (58mm printer)
  const html = `
  <div style="font-family: monospace; font-size:12px; width:100%; max-width:80mm; padding:8px; box-sizing:border-box;padding-bottom: 30px;">
    <div style="text-align:center; font-weight:bold">${toko?.nama || "STRUK PENJUALAN"}</div>
    ${toko?.alamat ? `<div style="text-align:center">${toko.alamat}</div>` : ""}
    <hr/>
    <div>No: ${notaId}</div>
    <div>${tanggalStr}</div>
    <hr/>

    <table style="width:100%; border-collapse:collapse; font-size:12px">
      <thead>
        <tr>
          <th style="text-align:left">Item</th>
          <th style="text-align:right">Qty</th>
          <th style="text-align:right">Harga</th>
          <th style="text-align:right">Sub</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(it => {
          const sub = it.qty * it.harga_jual - (it.potongan || 0);
          return `
            <tr>
              <td style="text-align:left">${it.nama}</td>
              <td style="text-align:right">${it.qty}</td>
              <td style="text-align:right">${fmt(it.harga_jual)}</td>
              <td style="text-align:right">${fmt(sub)}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>

    <hr/>
    <table style="width:100%; font-size:12px">
      <tr><td>Total</td><td style="text-align:right">${fmt(total)}</td></tr>
      <tr><td>Bayar</td><td style="text-align:right">${fmt(head.bayar)}</td></tr>
      <tr><td>Kembali</td><td style="text-align:right">${fmt(head.kembalian)}</td></tr>
      <tr><td>Metode</td><td style="text-align:right">${head.metode_bayar || ""}</td></tr>
    </table>
    <hr/>
    <div style="text-align:center; margin-top:10px">Terima Kasih üôè</div>
    <div style="height:60px">@</div> 
    <hr/>
  </div>
`;


  return { html, text };
}

function printNotaFromData(head, items, toko) {
  const { html } = generateNota(head, items, toko);
  const w = window.open("", "printWin");
  w.document.write(`
    <html>
      <head>
        <title>Struk Penjualan</title>
        <style>body { font-family: monospace; font-size: 12px; }</style>
      </head>
      <body>
        ${html}
        <script>
          window.onload = function(){ window.print(); setTimeout(()=>window.close(), 300); }
        <\/script>
      </body>
    </html>
  `);
  w.document.close();
}

async function fetchDetail(id) {
  const r = await fetch(`/api/penjualan/${id}`);
  if (!r.ok) throw new Error("Gagal ambil detail");
  return r.json(); 
  // { header:{client_tx_id,tanggal,...}, items:[{nama, qty, harga_jual, potongan}, ...] }
}

async function printById(id, toko) {
  try {
    const data = await fetchDetail(id);
    printNotaFromData(data.header, data.items, toko);
  } catch (e) {
    alert("Gagal cetak ulang: " + e.message);
  }
}

async function waById(id, nama, no_hp, toko) {
  try {
    const data = await fetchDetail(id);

    const number = (no_hp && /^62\d+$/.test(no_hp))
      ? no_hp
      : (data.header.no_hp || "");
    if (!/^62\d+$/.test(number)) {
      alert("Nomor WA tidak valid");
      return;
    }

    const { text } = generateNota(data.header, data.items, toko);

    const r = await fetch("/api/send-wa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ number, message: text })
    });
    const js = await r.json();
    if (!r.ok) throw new Error(js.msg || "Gagal kirim WA");
    alert("Pesan WA terkirim ‚úÖ");
  } catch (e) {
    alert("Gagal kirim WA: " + e.message);
  }
}


  </script>
</body>
</html>
