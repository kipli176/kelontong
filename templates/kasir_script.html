<script>
    // ======= UTIL =======
    const fmt = n => "Rp " + (n || 0).toLocaleString('id-ID');
    const load = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let cart = load("cart", []); // [{barcode,nama,harga_jual,harga_beli,qty, potongan}]
    let master = load("masterBarang", {}); // { barcode: {nama,harga_jual,harga_beli} }

    function tickNow() {
        const el = document.getElementById('now');
        if (el) {
            el.textContent =
                new Date().toLocaleString('id-ID', {
                    dateStyle: 'full',
                    timeStyle: 'medium'
                });
        }
    }
    setInterval(tickNow, 1000);
    tickNow();

    function getNumericIdOrNull(val) {
        // hanya pakai ID numerik; jika "local:xxxx" atau kosong -> null
        return (/^\d+$/).test(String(val || "")) ? parseInt(val, 10) : null;
    }
    // ======= RENDER CART =======
    function renderCart() {
        const tbody = document.getElementById('cartTable');
        tbody.innerHTML = "";
        let total = 0;

        cart.forEach((it, i) => {
            const pot = it.potongan || 0;
            const sub = (it.qty * it.harga_jual) - pot;
            //  const sub = it.qty * it.harga_jual - (it.potongan||0);
            total += sub;
            tbody.insertAdjacentHTML('beforeend', `
        <tr data-idx="${i}" class="odd:bg-white even:bg-slate-50">
          <td class="p-2 border">${i + 1}</td>
          <td class="p-2 border">${it.barcode}</td>
          <td class="p-2 border text-left">${it.nama}</td>
          <td class="p-2 border">${it.qty}</td>
          <td class="p-2 border">${fmt(it.harga_jual)}</td>
        <!-- POTONGAN: klik untuk edit -->
        <td class="p-2 border text-right col-potongan">
          <button class="underline text-blue-600" onclick="editPotongan(${i})">${fmt(pot)}</button>
        </td>
          <td class="p-2 border font-semibold">${fmt(sub)}</td>
          <td class="p-2 border">
            <button class="text-red-600 hover:underline" onclick="removeItem(${i})">üóëÔ∏è</button>
          </td>
        </tr>
      `);
        });
        document.getElementById('totalView').textContent = fmt(total);
        save("cart", cart);
    }

    function editPotongan(idx) {
        const tbody = document.getElementById('cartTable');
        if (!tbody) return;
        const tr = tbody.querySelector(`tr[data-idx="${idx}"]`);
        if (!tr) {
            // fallback: render ulang lalu coba lagi sekali
            renderCart();
            const tr2 = tbody.querySelector(`tr[data-idx="${idx}"]`);
            if (!tr2) return; // baris sudah tidak ada (mis. item dihapus)
            return editPotongan(idx);
        }
        const td = tr.querySelector('.col-potongan');
        if (!td) return;

        const current = parseInt(cart[idx].potongan || 0, 10);
        td.innerHTML = `<input type="number" class="w-24 border rounded px-2 py-1 text-right" id="pot-input-${idx}" value="${current}">`;
        const inp = document.getElementById(`pot-input-${idx}`);
        if (!inp) return;
        inp.focus();
        inp.select();

        const commit = () => {
            const val = parseInt(inp.value, 10);
            cart[idx].potongan = isNaN(val) ? 0 : Math.max(0, val);
            renderCart();
            // kembalikan fokus ke tombol potongan pada baris yang sama (jika masih ada)
            const trAfter = tbody.querySelector(`tr[data-idx="${idx}"]`);
            const btn = trAfter?.querySelector('.col-potongan button');
            if (btn) btn.focus();
        };

        inp.addEventListener('blur', commit, {
            once: true
        });
        inp.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                commit();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                renderCart();
            }
        });
    }

    function removeItem(idx) {
        cart.splice(idx, 1);
        renderCart();
    }

 
    // ======= PRINTING =======
    function generateNota(head, items, toko) {
  const total = items.reduce((a,b)=> a + (b.qty*b.harga_jual - (b.potongan||0)), 0);

  // gunakan client_tx_id ‚Üí ambil 8 digit terakhir
  const notaId = "TX-" + ((head.client_tx_id || "").slice(-8).toUpperCase());

  // baris item teks
  const textLines = items.map(it => {
    const sub = it.qty * it.harga_jual - (it.potongan || 0);
    return `${it.qty}x ${it.nama} @${fmt(it.harga_jual)} = ${fmt(sub)}`;
  });
const tanggalStr = new Date(head.tanggal || head.tanggal_client).toLocaleString("id-ID");
  // versi teks polos (untuk WA)
  const text = [
    (toko?.nama || "STRUK PENJUALAN"),
    (toko?.alamat || ""),
    `No: ${notaId}`,
    tanggalStr,
    "---------------------------",
    ...textLines,
    "---------------------------",
    `TOTAL    : ${fmt(total)}`,
    `BAYAR    : ${fmt(head.bayar)}`,
    `KEMBALI  : ${fmt(head.kembalian)}`,
    `METODE   : ${head.metode_bayar || ""}`,
    "",
    "Terima Kasih üôè"
  ].filter(Boolean).join("\n");

  // versi HTML (untuk print 58mm)
  const html = `
  <div style="font-family: monospace; font-size:12px; max-width:320px; margin:0 auto">
    <div style="text-align:center; font-weight:bold">${toko?.nama || "STRUK PENJUALAN"}</div>
    ${toko?.alamat ? `<div style="text-align:center">${toko.alamat}</div>` : ""}
    <hr/>
    <div>No: ${notaId}</div>
    <div>${tanggalStr}</div>
    <hr/>

    <table style="width:100%; border-collapse:collapse; font-size:12px">
      <thead>
        <tr>
          <th style="text-align:left">Item</th>
          <th style="text-align:right">Qty</th>
          <th style="text-align:right">Harga</th>
          <th style="text-align:right">Sub</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(it => {
          const sub = it.qty * it.harga_jual - (it.potongan || 0);
          return `
            <tr>
              <td style="text-align:left">${it.nama}</td>
              <td style="text-align:right">${it.qty}</td>
              <td style="text-align:right">${fmt(it.harga_jual)}</td>
              <td style="text-align:right">${fmt(sub)}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>

    <hr/>
    <table style="width:100%; font-size:12px">
      <tr><td>Total</td><td style="text-align:right">${fmt(total)}</td></tr>
      <tr><td>Bayar</td><td style="text-align:right">${fmt(head.bayar)}</td></tr>
      <tr><td>Kembali</td><td style="text-align:right">${fmt(head.kembalian)}</td></tr>
      <tr><td>Metode</td><td style="text-align:right">${head.metode_bayar || ""}</td></tr>
    </table>
    <hr/>
    <div style="text-align:center">Terima Kasih üôè</div>
  </div>
`;

  return { html, text };
}



function printNota(trx, toko) {
  const { html } = generateNota(trx, trx.items, toko); // ‚úÖ universal generator
  const w = window.open("", "nota");
  w.document.write(`
    <html>
      <head>
        <title>Nota</title>
        <style>
          body { font-family: monospace; font-size: 12px; }
        </style>
      </head>
      <body>
        ${html}
        <script>
          window.onload = function() {
            window.print();
            setTimeout(() => window.close(), 300);
          }
        <\/script>
      </body>
    </html>
  `);
  w.document.close();
}

    async function sendWa(tx, toko) {
  try {
    const sel = document.getElementById("payPembeli");
    const opt = [...sel.options].find(o => o.value == tx.pembeli);
    if (!opt) return;

    // ambil nomor hp lebih aman dari atribut data-hp
    let no_hp = opt.dataset.hp || "";
    if (!no_hp && opt.text.includes("‚Äî")) {
      no_hp = opt.text.split("‚Äî")[1].trim();
    }
    if (!/^62\d+$/.test(no_hp)) {
      console.warn("Nomor WA tidak valid:", no_hp);
      return;
    }

    // ‚úÖ pakai generator universal
    const { text } = generateNota(tx, tx.items, toko);

    const res = await fetch("/api/send-wa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ number: no_hp, message: text })
    });
    const js = await res.json();
    console.log("WA result:", js);
  } catch (err) {
    console.error("Gagal kirim WA:", err);
  }
}

    // ======= MODAL HANDLER =======
    function isOpen(id) {
        return document.getElementById(id)?.classList.contains('flex');
    }

    function openModal(id) {
        const el = document.getElementById(id);
        el.classList.remove('hidden');
        el.classList.add('flex');
        if (id === 'itemModal') {
            setTimeout(() => document.getElementById('mBarcode')?.focus(), 50);
        }
        if (id === 'payModal') {
            setTimeout(() => document.getElementById('payBayar')?.focus(), 50);
        }
        if (id === 'custModal') {
            setTimeout(() => document.getElementById('cNama')?.focus(), 50);
        } // ‚úÖ fokus nama pembeli
    }


    function focusQuickBarcode() {
        const q = document.getElementById("quickBarcode");
        if (q) {
            q.focus();
            q.select(); // optional: biar teks lama langsung ketimpa
        }
    }

    function closeModal(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add("hidden");
            el.classList.remove("flex");
        }

        // kalau modal item / modal bayar ditutup ‚Üí balik ke quickBarcode
        if (id === "itemModal" || id === "payModal") {
            focusQuickBarcode();
        }
    }

    function clearItemForm() {
        document.getElementById('mBarcode').value = "";
        document.getElementById('mNama').value = "";
        document.getElementById('mHargaJual').value = "";
        document.getElementById('mHargaBeli').value = "";
        document.getElementById('mQty').value = 1;
        document.getElementById('mBarcode').focus();
    }

    // ======= ITEM LOGIC =======
    function prefillFromMaster(barcode) {
        const hit = master[barcode];
        document.getElementById('mBarcode').value = barcode;
        if (hit) {
            document.getElementById('mNama').value = hit.nama || "";
            document.getElementById('mHargaJual').value = hit.harga_jual || "";
            document.getElementById('mHargaBeli').value = hit.harga_beli || "";
        } else {
            document.getElementById('mNama').value = "";
            document.getElementById('mHargaJual').value = "";
            document.getElementById('mHargaBeli').value = "";
        }
        document.getElementById('mQty').value = 1;
        document.getElementById('mQty').focus();
        document.getElementById('mQty').select();
    }

    function commitItem() {
        const barcode = (document.getElementById('mBarcode').value || "").trim();
        if (!barcode) return;
        const nama = (document.getElementById('mNama').value || "Barang");
        const hj = parseInt(document.getElementById('mHargaJual').value || "0");
        const hb = parseInt(document.getElementById('mHargaBeli').value || "0");
        const qty = Math.max(1, parseInt(document.getElementById('mQty').value || "1"));
        const potongan = 0;

        const ex = cart.find(i => i.barcode === barcode && i.harga_jual === hj);
        if (ex) {
            ex.qty += qty;
        } else {
            cart.push({
                barcode,
                nama,
                harga_jual: hj,
                harga_beli: hb,
                qty,
                potongan
            });
        }

        master[barcode] = {
            nama,
            harga_jual: hj,
            harga_beli: hb
        };
        save("masterBarang", master);

        renderCart();
        clearItemForm();
    }

    async function handleScan(barcode, {openModalIfNew=false}={}) {
        if (!barcode) return;

        if (master[barcode]) {
            // Barang sudah ada di cache lokal
            const hit = master[barcode];
            const ex = cart.find(i => i.barcode === barcode && i.harga_jual === hit.harga_jual);
            if (ex) {
            ex.qty += 1;
            } else {
            cart.push({
                barcode,
                nama: hit.nama || "Barang",
                harga_jual: hit.harga_jual || 0,
                harga_beli: hit.harga_beli || 0,
                qty: 1,
                potongan: 0
            });
            }
            renderCart();

        } else {
            try {
            // Ambil dari API v_barang_terbeli
            const res = await fetch(`/api/barang/${encodeURIComponent(barcode)}`);
            const barang = await res.json();

            if (barang) {
                // simpan ke master agar next scan lebih cepat
                master[barcode] = {
                nama: barang.nama,
                harga_jual: barang.harga_jual,
                harga_beli: barang.harga_beli
                };

                cart.push({
                barcode,
                nama: barang.nama || "Barang",
                harga_jual: barang.harga_jual || 0,
                harga_beli: barang.harga_beli || 0,
                qty: 1,
                potongan: 0
                });
                renderCart();
            } else {
                // Barang tidak ditemukan di DB
                if (openModalIfNew) {
                openModal('itemModal');
                }
                prefillFromMaster(barcode); // biar tetap isi barcode ke modal
            }
            } catch (err) {
            console.error("Gagal fetch barang:", err);
            if (openModalIfNew) {
                openModal('itemModal');
            }
            prefillFromMaster(barcode);
            }
        }
        }





    // ===== Customers (offline-first) =====
    function upsertPayPembeliOption(idValue, labelText, selectEl) {
        const opt = document.createElement("option");
        opt.value = idValue;
        opt.text = labelText;
        selectEl.add(opt);
        selectEl.value = idValue;
    }

    function loadLocalCustomers() {
        return JSON.parse(localStorage.getItem("localCustomers") || "[]");
    }

    function saveLocalCustomers(list) {
        localStorage.setItem("localCustomers", JSON.stringify(list));
    }

    // On page load, render any locally saved customers (so they show up even before server sync)
    (function hydrateLocalCustomersIntoSelect() {
        const sel = document.getElementById("payPembeli");
        const locals = loadLocalCustomers();

        for (const c of locals) {
            // gunakan local temp id prefiks untuk hindari bentrok
            const idVal = c.server_id ? String(c.server_id) : `local:${c.temp_id}`;

            // hindari duplikasi kalau server sudah render opsi dengan id yang sama
            if (![...sel.options].some(o => o.value === idVal)) {
                const opt = document.createElement("option");
                opt.value = idVal;
                opt.text = `${c.nama} ‚Äî ${c.no_hp || ""}`;
                if (c.no_hp) {
                    opt.dataset.hp = c.no_hp;   // ‚úÖ simpan nomor hp di atribut
                }
                sel.add(opt);
            }
        }
    })();


    function saveCustomer() {
    const nama = document.getElementById("cNama").value.trim();
    const no_hp = document.getElementById("cHp").value.trim();
    const alamat = document.getElementById("cAlamat").value.trim();

    if (!nama) {
        alert("Nama wajib diisi");
        return;
    }
    if (!no_hp) {
        alert("Nomor HP wajib diisi");
        return;
    }

    const temp_id = generateUUID();
    let locals = JSON.parse(localStorage.getItem("localCustomers") || "[]");
    const record = {
        temp_id,
        server_id: null,
        nama,
        no_hp,
        alamat
    };
    locals.push(record);
    localStorage.setItem("localCustomers", JSON.stringify(locals));

    // tambahkan ke dropdown & pilihkan
    const sel = document.getElementById("payPembeli");
    const opt = document.createElement("option");
    opt.value = `local:${temp_id}`;
    opt.text = `${nama} ‚Äî ${no_hp}`;
    opt.dataset.hp = no_hp;   // ‚úÖ simpan nomor hp di atribut
    sel.add(opt);
    sel.value = opt.value;

    // tutup modal & bersihkan
    closeModal('custModal');
    document.getElementById("cNama").value = "";
    document.getElementById("cHp").value = "";
    document.getElementById("cAlamat").value = "";

    focusPayAmount();

    // sync ke server jika online -> ganti value option menjadi ID server
    if (navigator.onLine) {
        fetch("/api/sync-pembeli", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nama, no_hp, alamat })
        })
        .then(r => r.json())
        .then(js => {
            if (js.status === "ok" && js.id) {
                // update local storage
                locals = JSON.parse(localStorage.getItem("localCustomers") || "[]");
                const idx = locals.findIndex(x => x.temp_id === temp_id);
                if (idx !== -1) {
                    locals[idx].server_id = js.id;
                    localStorage.setItem("localCustomers", JSON.stringify(locals));
                }
                // ganti value option di dropdown
                for (const o of sel.options) {
                    if (o.value === `local:${temp_id}`) {
                        o.value = String(js.id);
                        o.dataset.hp = no_hp;  // ‚úÖ pastikan tetap ada data-hp setelah sync
                        break;
                    }
                }
            }
        })
        .catch(err => console.error("Sync pembeli gagal:", err));
    }
}



    // pasang shortcut enter/esc khusus modal pembeli (tidak men-trigger yang lain)
    (function wireCustomerModalKeys() {
        const cust = document.getElementById('custModal');
        if (!cust) return;

        cust.addEventListener('keydown', (e) => {
            if (!isOpen('custModal')) return; // hanya saat modal pembeli terbuka

            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation(); // ‚úÖ cegah tembus ke listener global
                saveCustomer();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation(); // ‚úÖ cegah tembus ke listener global
                closeModal('custModal');
                focusPayAmount();
            }
        });
    })();
    // ======= BAYAR =======
    async function openPaymentModal() {
        if (cart.length === 0) {
            alert("Keranjang kosong.");
            return;
        }

        await refreshPembeliOptions();

        const total = cart.reduce((a, b) => a + b.qty * b.harga_jual - (b.potongan || 0), 0);
        document.getElementById('payTotal').textContent = fmt(total);

        const sel = document.getElementById('payPembeli');
        // jika belum ada pilihan, pilih opsi pertama yang punya value (bukan placeholder kosong)
        if (!sel.value || sel.value === "") {
            const firstReal = [...sel.options].find(o => (o.value ?? "") !== "");
            if (firstReal) sel.value = firstReal.value;
        }
        document.getElementById('payBayar').value = "";
        document.getElementById('payKembalian').textContent = fmt(0);
        openModal('payModal');

        const bayarEl = document.getElementById('payBayar');
        const kembalianEl = document.getElementById('payKembalian');


        // kembalian otomatis
        const totalNow = total; // lock total untuk handler ini
        bayarEl.oninput = () => {
            const bayar = parseInt(bayarEl.value || "0", 10);
            const k = bayar - totalNow;
            kembalianEl.textContent = fmt(k);
            kembalianEl.className = "font-semibold " + (k < 0 ? "text-red-600" : "text-emerald-600");
        };

        // ENTER di kolom bayar -> langsung selesai
        bayarEl.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishPayment();
            }
        };

        // jaga-jaga: ENTER di mana pun dalam payModal juga memicu bayar
        const payModal = document.getElementById('payModal');
        const handleEnter = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishPayment();
            }
        };
        payModal.addEventListener('keydown', handleEnter, {
            once: true
        });
    }







    function focusPayAmount() {
        // fokuskan ke input nominal bayar jika payModal masih terbuka
        const el = document.getElementById('payBayar');
        if (document.getElementById('payModal')?.classList.contains('flex') && el) {
            setTimeout(() => el.focus(), 30);
        }
    }

    function finishPayment() {
        const total = cart.reduce((a, b) => a + Math.max(0, b.qty) * Math.max(0, b.harga_jual) - Math.max(0, b.potongan || 0), 0);
        const bayar = parseInt(document.getElementById('payBayar').value || "0", 10);
        const metode = document.getElementById('payMetode').value;
        const selVal = document.getElementById('payPembeli').value;
        const pembeli_id = getNumericIdOrNull(selVal); // null kalau "local:..."

        const kembalian = bayar - total;

        // ambil toko_id dari atribut body (dibawa server-side saat render)
        const tokoId = parseInt(document.body.dataset.tokoId || "0", 10);

        const tx = {
            client_tx_id: generateUUID(),
            tanggal_client: new Date().toISOString(),
            metode_bayar: metode,
            bayar,
            kembalian,
            pembeli: pembeli_id, // null atau integer
            toko_id: tokoId,     // ‚úÖ penting untuk backend
            items: cart.map(it => ({
                barcode: it.barcode,
                nama: it.nama,
                qty: Math.max(0, it.qty),
                harga_jual: Math.max(0, it.harga_jual),
                harga_beli: Math.max(0, it.harga_beli),
                potongan: Math.max(0, it.potongan || 0)
            }))
        };

        // simpan transaksi offline
        let allTx = load("transactions", []);
        allTx.push(tx);
        save("transactions", allTx);

        // reset keranjang
        cart = [];
        renderCart();
        closeModal('payModal');
        alert("‚úÖ Transaksi tersimpan offline. Siap disinkronkan saat online.");

        // kirim WA jika ada pembeli
        if (tx.pembeli) {
            sendWa(tx, {
                nama: document.body.dataset.tokoNama || "",
                alamat: document.body.dataset.tokoAlamat || ""
            });
        }
        // cetak struk
        printNota(tx, {
            nama: document.body.dataset.tokoNama || "",
            alamat: document.body.dataset.tokoAlamat || ""
        });
        // sync otomatis kalau online
        if (navigator.onLine) {
            syncOfflineData();
        }
    }

    function generateUUID() {
        if (crypto?.randomUUID) {
            return crypto.randomUUID();
        }
        // fallback: UUID v4 pseudo
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        }
    function rebuildPembeliSelect(serverList) {
        const sel = document.getElementById("payPembeli");
        if (!sel) return;

        const prev = sel.value;
        const locals = loadLocalCustomers();

        const map = new Map();

        // server-side pembeli
        (serverList || []).forEach(p => {
            const id = String(p.id);
            map.set(id, {
                value: id,
                label: `${p.nama} ‚Äî ${p.no_hp||""}`.trim(),
                no_hp: p.no_hp || ""
            });
        });

        // pembeli lokal (offline)
        locals.forEach(c => {
            if (c.server_id) {
                const id = String(c.server_id);
                map.set(id, {
                    value: id,
                    label: `${c.nama} ‚Äî ${c.no_hp||""}`.trim(),
                    no_hp: c.no_hp || ""
                });
            } else {
                const id = `local:${c.temp_id}`;
                map.set(id, {
                    value: id,
                    label: `${c.nama} ‚Äî ${c.no_hp||""}`.trim(),
                    no_hp: c.no_hp || ""
                });
            }
        });

        // render ulang
        sel.innerHTML = "";
        sel.insertAdjacentHTML("beforeend", `<option value="">(Tanpa pembeli)</option>`);

        const arr = Array.from(map.values()).sort((a, b) => a.label.localeCompare(b.label, 'id'));
        arr.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o.value;
            opt.text = o.label;
            if (o.no_hp) {
                opt.dataset.hp = o.no_hp;  // ‚úÖ simpan nomor hp di atribut
            }
            sel.add(opt);
        });

        if (prev && [...sel.options].some(o => o.value === prev)) {
            sel.value = prev;
        } else {
            const firstReal = [...sel.options].find(o => (o.value ?? "") !== "");
            if (firstReal) sel.value = firstReal.value;
        }
    }


    async function refreshPembeliOptions() {
        try {
            const res = await fetch("/api/pembeli");
            if (!res.ok) throw new Error("HTTP " + res.status);
            const serverList = await res.json(); // [{id,nama,no_hp}]
            rebuildPembeliSelect(serverList);
        } catch (err) {
            console.warn("Gagal load pembeli dari server, pakai lokal saja:", err);
            rebuildPembeliSelect([]); // tetap render dari lokal
        }
    }

    //  function finishPayment(){
    //    const total = cart.reduce((a,b)=>a + b.qty*b.harga_jual - (b.potongan||0), 0);
    //    const bayar = parseInt(document.getElementById('payBayar').value||"0");
    //    const metode = document.getElementById('payMetode').value;
    //    const pembeli_id = document.getElementById('payPembeli').value || null;
    //    const kembalian = bayar - total;

    //    let tx = load("transactions", []);
    //    tx.push({
    //      client_tx_id: generateUUID(),
    //      tanggal_client: new Date().toISOString(),
    //      metode_bayar: metode,
    //      bayar, kembalian,
    //      pembeli: pembeli_id ? parseInt(pembeli_id) : null,
    //      items: cart
    //    });
    //    save("transactions", tx);

    //    cart = [];
    //    renderCart();
    //    closeModal('payModal');
    //    alert("‚úÖ Transaksi tersimpan offline. Siap disinkronkan saat online.");

    // TODO: panggil fungsi sync otomatis kalau online
    //    if(navigator.onLine){
    //      syncOfflineData();
    //    }
    //  }

    // ======= SYNC =======
    async function syncOfflineData() {
        let tx = load("transactions", []);
        if (tx.length === 0) return;
        for (const t of tx) {
            try {
                const res = await fetch("/api/sync-transaksi", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(t)
                });
                const js = await res.json();
                if (js.status === "ok" || js.status === "duplicate") {
                    tx = tx.filter(x => x.client_tx_id !== t.client_tx_id);
                    save("transactions", tx);
                }
            } catch (e) {
                console.error("Gagal sync:", e);
            }
        }
    }

    window.addEventListener('online', syncOfflineData);

    // ======= SHORTCUTS =======
    document.addEventListener('keydown', (e) => {
        if (e.key === '+') {
            e.preventDefault();
            openModal('itemModal');
        }
        if (e.key === 'F2') {
            e.preventDefault();
            openPaymentModal();
        }
        if (e.key === 'Escape') {
            closeModal('itemModal');
            closeModal('payModal');
            closeModal('custModal'); // ‚úÖ
        }

        if (e.key === 'Enter' && document.activeElement.id === 'quickBarcode') {
            e.preventDefault();
            const bc = document.getElementById('quickBarcode').value.trim();
            document.getElementById('quickBarcode').value = "";
            handleScan(bc, {
                openModalIfNew: true
            });
        }

        if (e.key === 'Enter' && isOpen('payModal') && !isOpen('custModal')) { // ‚úÖ abaikan kalau custModal terbuka
            if (document.activeElement.id !== 'payBayar') {
                e.preventDefault();
                finishPayment();
            }
        }
if (e.key === 'Enter' && document.getElementById('itemModal').classList.contains('flex')) {
  if (document.activeElement.id === 'mBarcode') {
    e.preventDefault();
    const bc = document.getElementById('mBarcode').value.trim();
    if (!bc) return;

    console.log("Enter pada mBarcode, hanya isi field modal (tidak update cart)");

    // hanya isi field modal, tidak panggil handleScan/cart update
    prefillFromMaster(bc);

  } else {
    e.preventDefault();
    console.log("Enter di modal tapi bukan di mBarcode ‚Üí commitItem()");
    commitItem();
  }
}
    });



// ======= INIT =======
document.getElementById('btnTambah').onclick = () => openModal('itemModal');
document.getElementById('btnBayar').onclick = openPaymentModal;
renderCart();
syncOfflineData();
    document.addEventListener("DOMContentLoaded", () => {
    const q = document.getElementById("quickBarcode");
    if (q) q.focus();
    });
</script>