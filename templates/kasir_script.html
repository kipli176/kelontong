
<script src="/static/js/esc-pos-encoder.umd.min.js"></script>
<script src="/static/js/ua-parser.min.js"></script>
<script src="/static/js/nota-utils.js"></script>
<script src="/static/js/app.js"></script>
<script>
    // ======= UTILITAS DASAR =======
    const fmt = n => "Rp " + (n || 0).toLocaleString("id-ID");
    const load = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    function generateUUID() {
        if (crypto?.randomUUID) {
            return crypto.randomUUID();
        }
        // fallback: UUID v4 pseudo
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === "x" ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function getNumericIdOrNull(val) {
        return (/^\d+$/).test(String(val || "")) ? parseInt(val, 10) : null;
    }

    function tickNow() {
        const el = document.getElementById("now");
        if (el) {
            el.textContent = new Date().toLocaleString("id-ID", {
                dateStyle: "full",
                timeStyle: "medium",
            });
        }
    }
    setInterval(tickNow, 1000);
    tickNow();

    let cart = load("cart", []); // [{barcode,nama,harga_jual,harga_beli,qty,potongan}]
    let master = load("masterBarang", {}); // { barcode: {nama,harga_jual,harga_beli} }

    function clearItemForm() {
        document.getElementById("mBarcode").value = "";
        document.getElementById("mNama").value = "";
        document.getElementById("mHargaJual").value = "";
        document.getElementById("mHargaBeli").value = "";
        document.getElementById("mQty").value = 1;
        document.getElementById("mBarcode").focus();
    }

    /**
     * Populate <select> element dengan data
     * @param {HTMLSelectElement} selectEl - elemen select tujuan
     * @param {Array} items - array data
     * @param {Function} getValue - fungsi (item) => string, untuk value option
     * @param {Function} getLabel - fungsi (item) => string, untuk teks option
     * @param {Function} [extraHandler] - opsional, fungsi (item, optionEl) => void untuk set atribut tambahan
     * @param {String} [defaultText] - opsi pertama default
     */
    function populateSelect(selectEl, items, getValue, getLabel, extraHandler, defaultText = "(Pilih)") {
        if (!selectEl) return;
        const prev = selectEl.value;

        // kosongkan dulu
        selectEl.innerHTML = "";
        if (defaultText) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.text = defaultText;
            selectEl.add(opt);
        }

        // buat opsi baru
        items.forEach((item) => {
            const opt = document.createElement("option");
            opt.value = getValue(item);
            opt.text = getLabel(item);
            if (extraHandler) extraHandler(item, opt);
            selectEl.add(opt);
        });

        // restore pilihan sebelumnya jika masih ada
        if (prev && [...selectEl.options].some((o) => o.value === prev)) {
            selectEl.value = prev;
        }
    }

    const shortcutMap = {};

    /**
     * Daftarkan shortcut baru
     * @param {string} key - tombol keyboard, contoh "F2", "+", "Escape"
     * @param {function} action - fungsi yang dijalankan
     */
    function registerShortcut(key, action) {
        shortcutMap[key] = action;
    }

    /**
     * Listener global keyboard
     */
    document.addEventListener("keydown", (e) => {
        const fn = shortcutMap[e.key];
        if (fn) {
            e.preventDefault();
            fn(e);
        }
    });

    // ======= MASTER BARANG & TYPEAHEAD =======
    async function preloadBarang() {
        try {
            const res = await fetch("/api/all-barang");
            if (!res.ok) throw new Error("HTTP " + res.status);
            const list = await res.json();

            const master = {};
            for (const b of list) {
                master[b.barcode] = {
                    nama: b.nama,
                    harga_jual: b.harga_jual,
                    harga_beli: b.harga_beli,
                };
            }
            save("masterBarang", master);
            console.log("✅ Master barang terisi:", Object.keys(master).length);
        } catch (err) {
            console.error("Gagal preload barang:", err);
        }
    }
    window.addEventListener("load", preloadBarang);

    function suggestBarang(query) {
        query = (query || "").toLowerCase();
        const master = load("masterBarang", {});
        return Object.entries(master)
            .map(([barcode, b]) => ({ barcode, ...b }))
            .filter(
                (b) =>
                    b.barcode.toLowerCase().includes(query) ||
                    (b.nama || "").toLowerCase().includes(query)
            )
            .slice(0, 10);
    }

    function selectSuggestion(inputEl, item) {
        inputEl.value = item.barcode;
        const box = document.getElementById(inputEl.id + "-suggestions");
        box?.classList.add("hidden");

        // update master
        master[item.barcode] = {
            nama: item.nama,
            harga_jual: item.harga_jual,
            harga_beli: item.harga_beli
        };
        save("masterBarang", master);

        // isi form sesuai konteks
        if (inputEl.id === "quickBarcode") {
            openModal("itemModal");
            prefillFromMaster(item.barcode);
        }
        if (inputEl.id === "mBarcode") {
            prefillFromMaster(item.barcode);
            setTimeout(() => {
                document.getElementById("mQty")?.focus();
                document.getElementById("mQty")?.select();
            }, 30);
        }
    }

    function showSuggestions(inputEl, results) {
        const box = document.getElementById(inputEl.id + "-suggestions");
        if (!box) return;

        if (!results.length) {
            box.classList.add("hidden");
            return;
        }

        box.innerHTML = "";
        results.forEach((item) => {
            const opt = document.createElement("div");
            opt.className = "px-2 py-1 hover:bg-blue-100 cursor-pointer text-sm";
            opt.textContent = `${item.barcode} — ${item.nama}`;
            opt.__data = item; // simpan data item di elemen
            opt.onclick = () => selectSuggestion(inputEl, item);
            box.appendChild(opt);
        });

        box.classList.remove("hidden");
    }


    function enableKeyboardNav(inputEl) {
        let selectedIndex = -1;

        inputEl.addEventListener("keydown", (e) => {
            const box = document.getElementById(inputEl.id + "-suggestions");
            if (!box || box.classList.contains("hidden")) return;

            const options = box.querySelectorAll("div");
            if (!options.length) return;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % options.length;
            }
            if (e.key === "ArrowUp") {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + options.length) % options.length;
            }
            if (e.key === "Enter") {
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < options.length) {
                    const item = options[selectedIndex].__data;
                    selectSuggestion(inputEl, item);
                    selectedIndex = -1;
                    e.stopPropagation(); // ⛔ cegah lanjut ke wireModalKeys
                }
            }
            if (e.key === "Escape") {
                e.preventDefault();
                box.classList.add("hidden");
                selectedIndex = -1;
            }

            options.forEach((opt, i) => {
                opt.classList.toggle("bg-blue-500", i === selectedIndex);
                opt.classList.toggle("text-white", i === selectedIndex);
            });
        });

        inputEl.addEventListener("input", () => {
            selectedIndex = -1;
        });
    }

    enableKeyboardNav(document.getElementById("quickBarcode"));
    enableKeyboardNav(document.getElementById("mBarcode"));

    function attachSuggestListener(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const box = document.getElementById(id + "-suggestions");

        el.addEventListener("input", (e) => {
            const q = e.target.value.trim();
            if (q.length < 2) {
                box?.classList.add("hidden");
                return;
            }
            const hasil = suggestBarang(q);
            showSuggestions(e.target, hasil);

            // ✅ kalau hanya ada 1 hasil & query cocok persis, auto pilih
            if (id === "mBarcode" && hasil.length === 1 && hasil[0].barcode === q) {
                selectSuggestion(el, hasil[0]);
            }
        });

        el.addEventListener("blur", () => {
            setTimeout(() => box?.classList.add("hidden"), 150);
        });
    }

    ["quickBarcode", "mBarcode"].forEach(attachSuggestListener);


    function handleQuickBarcodeInput(val) {
        openModal("itemModal");
        prefillFromMaster(val);

        setTimeout(() => {
            const nama = document.getElementById("mNama").value.trim();
            const harga = document.getElementById("mHargaJual").value.trim();

            if (!nama || !harga) {
                // 🚨 Barang tidak ada di master → fokus ke Nama
                document.getElementById("mNama")?.focus();
                document.getElementById("mNama")?.select();
            } else {
                // ✅ Barang ada → fokus ke Qty
                document.getElementById("mQty")?.focus();
                document.getElementById("mQty")?.select();
            }
        }, 30);
    }


    // ======= CART (KERANJANG) =======
    function renderCart() {
        const tbody = document.getElementById("cartTable");
        tbody.innerHTML = "";
        let total = 0;

        cart.forEach((it, i) => {
            const pot = it.potongan || 0;
            const sub = it.qty * it.harga_jual - pot;
            total += sub;

            tbody.insertAdjacentHTML(
                "beforeend",
                `
    <tr data-idx="${i}" class="odd:bg-white even:bg-slate-50">
      <td class="p-2 border">${i + 1}</td>
      <td class="p-2 border">${it.barcode}</td>
      <td class="p-2 border text-left">${it.nama}</td>
      <td class="p-2 border text-center col-qty">
        <button class="underline text-blue-600" onclick="editCell(${i}, 'qty', '.col-qty', 1)">${it.qty}</button>
      </td>
      <td class="p-2 border">${fmt(it.harga_jual)}</td>
      <td class="p-2 border text-right col-potongan">
        <button class="underline text-blue-600" onclick="editCell(${i}, 'potongan', '.col-potongan', 0)">${fmt(pot)}</button>
      </td>
      <td class="p-2 border font-semibold">${fmt(sub)}</td>
      <td class="p-2 border">
        <button class="text-red-600 hover:underline" onclick="removeItem(${i})">🗑️</button>
      </td>
    </tr>
  `
            );
        });

        document.getElementById("totalView").textContent = fmt(total);
        save("cart", cart);
    }

    function editCell(idx, field, selector, min = 0) {
        const tbody = document.getElementById("cartTable");
        const tr = tbody.querySelector(`tr[data-idx="${idx}"]`);
        const td = tr?.querySelector(selector);
        if (!td) return;

        const current = parseInt(cart[idx][field] || 0, 10);
        td.innerHTML = `<input type="number" min="${min}" class="w-20 border rounded px-2 py-1 text-right" id="cell-input-${field}-${idx}" value="${current}">`;

        const inp = document.getElementById(`cell-input-${field}-${idx}`);
        inp.focus();
        inp.select();

        const commit = () => {
            let val = parseInt(inp.value, 10);
            if (isNaN(val) || val < min) val = min;
            cart[idx][field] = val;
            renderCart();
        };

        inp.addEventListener("blur", commit, { once: true });
        inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter") { e.preventDefault(); commit(); }
            if (e.key === "Escape") { e.preventDefault(); renderCart(); }
        });
    }
 
    function removeItem(idx) {
        cart.splice(idx, 1);
        renderCart();
    }
</script>
<script>
    // ======= ITEM MODAL / LOGIC =======
    function prefillFromMaster(barcode) {
        const hit = master[barcode];
        document.getElementById("mBarcode").value = barcode;
        if (hit) {
            document.getElementById("mNama").value = hit.nama || "";
            document.getElementById("mHargaJual").value = hit.harga_jual || "";
            document.getElementById("mHargaBeli").value = hit.harga_beli || "";
        } else {
            document.getElementById("mNama").value = "";
            document.getElementById("mHargaJual").value = "";
            document.getElementById("mHargaBeli").value = "";
        }
        document.getElementById("mQty").value = 1;
        document.getElementById("mQty").focus();
        document.getElementById("mQty").select();
    }

    function commitItem() {
        const barcode = (document.getElementById("mBarcode").value || "").trim();
        if (!barcode) return;
        const nama = document.getElementById("mNama").value || "Barang";
        const hj = parseInt(document.getElementById("mHargaJual").value || "0");
        const hb = parseInt(document.getElementById("mHargaBeli").value || "0");
        const qty = Math.max(1, parseInt(document.getElementById("mQty").value || "1"));
        const potongan = 0;
        if (isNaN(hj) || hj <= 0) return alert("Harga jual wajib diisi dan lebih dari 0");
        if (isNaN(hb) || hb < 0) return alert("Harga beli wajib diisi dan lebih dari 0");

        const ex = cart.find((i) => i.barcode === barcode && i.harga_jual === hj);
        if (ex) {
            ex.qty += qty;
        } else {
            cart.push({ barcode, nama, harga_jual: hj, harga_beli: hb, qty, potongan });
        }

        master[barcode] = { nama, harga_jual: hj, harga_beli: hb };
        save("masterBarang", master);

        renderCart();
        clearItemForm();
    }
 
    // ======= CUSTOMERS (PEMBELI) =======
    function loadLocalCustomers() {
        return JSON.parse(localStorage.getItem("localCustomers") || "[]");
    }

    function saveLocalCustomers(list) {
        localStorage.setItem("localCustomers", JSON.stringify(list));
    }

    function upsertPayPembeliOption(idValue, labelText, selectEl) {
        const opt = document.createElement("option");
        opt.value = idValue;
        opt.text = labelText;
        selectEl.add(opt);
        selectEl.value = idValue;
    }

    function populatePembeliSelect(serverList = []) {
    const sel = document.getElementById("payPembeli");
    if (!sel) return;

    const locals = loadLocalCustomers();
    const map = new Map();

    // gabung server + lokal
    serverList.forEach((p) => {
        const id = String(p.id);
        map.set(id, { value: id, nama: p.nama, no_hp: p.no_hp || "" });
    });
    locals.forEach((c) => {
        const id = c.server_id ? String(c.server_id) : `local:${c.temp_id}`;
        map.set(id, { value: id, nama: c.nama, no_hp: c.no_hp || "" });
    });

    const arr = Array.from(map.values()).sort((a, b) =>
        a.nama.localeCompare(b.nama, "id")
    );

    populateSelect(
        sel,
        arr,
        (o) => o.value,
        (o) => `${o.nama}${o.no_hp ? " — " + o.no_hp : ""}`,
        (o, opt) => { if (o.no_hp) opt.dataset.hp = o.no_hp; },
        "(Tanpa pembeli)"
    );
}


    function addCustomerOptionToSelect(customer, selectEl) {
        const id = customer.server_id ? String(customer.server_id) : `local:${customer.temp_id}`;
        const opt = document.createElement("option");
        opt.value = id;
        opt.text = `${customer.nama} — ${customer.no_hp}`;
        if (customer.no_hp) opt.dataset.hp = customer.no_hp;
        selectEl.add(opt);
        selectEl.value = id;
    }

    function syncCustomerWithServer(temp_id, data, selectEl) {
        fetch("/api/sync-pembeli", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        })
            .then((r) => r.json())
            .then((js) => {
                if (js.status === "ok" && js.id) {
                    let locals = loadLocalCustomers();
                    const idx = locals.findIndex((x) => x.temp_id === temp_id);
                    if (idx !== -1) {
                        locals[idx].server_id = js.id;
                        saveLocalCustomers(locals);
                    }
                    for (const o of selectEl.options) {
                        if (o.value === `local:${temp_id}`) {
                            o.value = String(js.id);
                            o.dataset.hp = data.no_hp;
                            break;
                        }
                    }
                }
            })
            .catch((err) => console.error("Sync pembeli gagal:", err));
    }

    function saveCustomer() {
        const nama = document.getElementById("cNama").value.trim();
        const no_hp = document.getElementById("cHp").value.trim();
        const alamat = document.getElementById("cAlamat").value.trim();

        if (!nama) return alert("Nama wajib diisi");
        if (!no_hp) return alert("Nomor HP wajib diisi");

        const temp_id = generateUUID();
        const record = { temp_id, server_id: null, nama, no_hp, alamat };

        let locals = loadLocalCustomers();
        locals.push(record);
        saveLocalCustomers(locals);

        const sel = document.getElementById("payPembeli");
        addCustomerOptionToSelect(record, sel);

        closeModal("custModal");
        document.getElementById("cNama").value = "";
        document.getElementById("cHp").value = "";
        document.getElementById("cAlamat").value = "";
        focusPayAmount();

        if (navigator.onLine) {
            syncCustomerWithServer(temp_id, { nama, no_hp, alamat }, sel);
        }
    }

    async function refreshPembeliOptions() {
        try {
            const res = await fetch("/api/pembeli");
            if (!res.ok) throw new Error("HTTP " + res.status);
            const serverList = await res.json();
            populatePembeliSelect(serverList);
        } catch (err) {
            console.warn("Gagal load pembeli dari server, pakai lokal saja:", err);
            populatePembeliSelect([]);
        }
    }


    // ======= PEMBAYARAN =======
    async function openPaymentModal() {
        if (cart.length === 0) {
            alert("Keranjang kosong.");
            return;
        }

        await refreshPembeliOptions();

        const total = cart.reduce((a, b) => a + b.qty * b.harga_jual - (b.potongan || 0), 0);
        document.getElementById("payTotal").textContent = fmt(total);

        const sel = document.getElementById("payPembeli");
        if (!sel.value || sel.value === "") {
            const firstReal = [...sel.options].find((o) => (o.value ?? "") !== "");
            if (firstReal) sel.value = firstReal.value;
        }

        document.getElementById("payBayar").value = "";
        document.getElementById("payKembalian").textContent = fmt(0);

        // tombol selesai default disabled
        const btnSelesai = document.getElementById("btnSelesai");
        if (btnSelesai) btnSelesai.disabled = true;

        openModal("payModal");

        const bayarEl = document.getElementById("payBayar");
        const kembalianEl = document.getElementById("payKembalian");

        const totalNow = total;
        bayarEl.oninput = () => {
            const bayar = parseInt(bayarEl.value || "0", 10);
            const k = bayar - totalNow;
            kembalianEl.textContent = fmt(k);
            kembalianEl.className = "font-semibold " + (k < 0 ? "text-red-600" : "text-emerald-600");

            // ✅ enable btnSelesai kalau kembalian >= 0
            if (btnSelesai) btnSelesai.disabled = k < 0;
        };

        bayarEl.onkeydown = (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (!btnSelesai.disabled) {
                    finishPayment();
                }
            }
        };

        const payModal = document.getElementById("payModal");
        const handleEnter = (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                if (!btnSelesai.disabled) {
                    finishPayment();
                }
            }
        };
        payModal.addEventListener("keydown", handleEnter, { once: true });
    }

    function focusPayAmount() {
        const el = document.getElementById("payBayar");
        if (document.getElementById("payModal")?.classList.contains("flex") && el) {
            setTimeout(() => el.focus(), 30);
        }
    }

    function finishPayment() {
        const total = cart.reduce(
            (a, b) => a + Math.max(0, b.qty) * Math.max(0, b.harga_jual) - Math.max(0, b.potongan || 0),
            0
        );
        const bayar = parseInt(document.getElementById("payBayar").value || "0", 10);
        const metode = document.getElementById("payMetode").value;
        const selVal = document.getElementById("payPembeli").value;
        const pembeli_id = getNumericIdOrNull(selVal);
        const kembalian = bayar - total;

        const tokoId = parseInt(document.body.dataset.tokoId || "0", 10);

        const tx = {
            client_tx_id: generateUUID(),
            tanggal_client: new Date().toISOString(),
            metode_bayar: metode,
            bayar,
            kembalian,
            pembeli: pembeli_id,
            toko_id: tokoId,
            items: cart.map((it) => ({
                barcode: it.barcode,
                nama: it.nama,
                qty: Math.max(0, it.qty),
                harga_jual: Math.max(0, it.harga_jual),
                harga_beli: Math.max(0, it.harga_beli),
                potongan: Math.max(0, it.potongan || 0),
            })),
        };

        let allTx = load("transactions", []);
        allTx.push(tx);
        save("transactions", allTx);

        cart = [];
        renderCart();
        closeModal("payModal");
        alert("✅ Transaksi tersimpan offline. Siap disinkronkan saat online.");

        if (tx.pembeli) {
            sendWa(tx, {
                nama: document.body.dataset.tokoNama || "",
                alamat: document.body.dataset.tokoAlamat || "",
            });
        }

        printNota(tx, {
            nama: document.body.dataset.tokoNama || "",
            alamat: document.body.dataset.tokoAlamat || "",
        });

        if (navigator.onLine) {
            syncOfflineData();
        }
    }
</script>
<script>
    // ======= SINKRONISASI OFFLINE =======

    async function sendWa(tx, toko) {
        // ambil nomor hp dari option pembeli
        const pembeliOpt = document.querySelector(`#payPembeli option[value="${tx.pembeli}"]`);
        const hp = pembeliOpt?.dataset.hp || "";
        if (!hp) {
            alert("Nomor HP pembeli tidak ditemukan");
            return;
        }

        // generate nota
        const s = generateNotaWA(tx, tx.items, toko).replace(/<[^>]+>/g, "");

        try {
            const res = await fetch("/api/send-wa", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    number: hp,    // ✅ sesuai backend
                    message: s     // ✅ sesuai backend
                }),
            });
            const js = await res.json();
            if (js.status === "sent") {
                console.log("✅ WA terkirim");
            } else {
                console.warn("⚠️ Gagal kirim WA:", js);
                alert("WA gagal dikirim, coba manual.");
            }
        } catch (err) {
            console.error("⚠️ Error sendWa:", err);
            alert("Tidak bisa kirim WA");
        }
    }
    async function syncOfflineData() {
        let tx = load("transactions", []);
        if (tx.length === 0) return;
        for (const t of tx) {
            try {
                const res = await fetch("/api/sync-transaksi", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(t)
                });
                const js = await res.json();
                if (js.status === "ok" || js.status === "duplicate") {
                    tx = tx.filter(x => x.client_tx_id !== t.client_tx_id);
                    save("transactions", tx);
                }
            } catch (e) {
                console.error("Gagal sync:", e);
            }
        }
    }

    // ======= MODAL HANDLING =======

    function isOpen(id) {
        return document.getElementById(id)?.classList.contains("flex");
    }

    const modalFocusMap = {
        itemModal: "mBarcode",
        payModal: "payBayar",
        custModal: "cNama"
    };

    function openModal(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove("hidden");
            el.classList.add("flex");
            setTimeout(() => {
                const focusId = modalFocusMap[id];
                if (focusId) document.getElementById(focusId)?.focus();
            }, 30);
        }
    }


    function closeModal(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add("hidden");
            el.classList.remove("flex");
        }
    }

    function focusQuickBarcode() {
        const el = document.getElementById("quickBarcode");
        if (el) {
            el.focus();
            el.select();
        }
    }
       

    function wireModalKeys(modalId, { onEnter, onEscape }) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        modal.addEventListener("keydown", (e) => {
            if (!isOpen(modalId)) return;

            if (e.key === "Enter" && onEnter) {
                e.preventDefault();
                e.stopPropagation();
                onEnter();
            }
            if (e.key === "Escape" && onEscape) {
                e.preventDefault();
                e.stopPropagation();
                onEscape();
            }
        });
    }

    // Pemakaian:
    wireModalKeys("itemModal", {
        onEnter: () => {
            // 🚫 Kalau fokus masih di input mBarcode → jangan commit dulu
            if (document.activeElement.id === "mBarcode") {
                return; // biarkan enableKeyboardNav yang handle
            }
            commitItem(); // ✅ commit hanya jika bukan di mBarcode
        },
        onEscape: () => { 
            closeModal("itemModal"); 
            focusQuickBarcode(); 
        }
    });

    wireModalKeys("custModal", {
        onEnter: () => saveCustomer(),
        onEscape: () => { closeModal("custModal"); focusPayAmount(); }
    });

    // ======= INISIALISASI & SHORTCUTS =======
 
    // Tambah barang (shortcut: +)
    registerShortcut("+", () => {
        openModal("itemModal");
        document.getElementById("mBarcode")?.focus();
    });

    // Bayar (shortcut: F2)
    registerShortcut("F2", openPaymentModal);

    // Tutup modal (shortcut: Escape)
    registerShortcut("Escape", () => {
        if (isOpen("itemModal")) {
            closeModal("itemModal"); focusQuickBarcode();
        } else if (isOpen("payModal")) {
            closeModal("payModal"); focusQuickBarcode();
        } else if (isOpen("custModal")) {
            closeModal("custModal"); focusQuickBarcode();
        }
    });
    
    document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && document.activeElement.id === "quickBarcode") {
            e.preventDefault();
            const val = document.getElementById("quickBarcode").value.trim();
            if (val) {
                document.getElementById("quickBarcode").value = "";
                handleQuickBarcodeInput(val);
            }
        }
    });
    
    (function setupQuickBarcodeAutoCheck() {
        const inp = document.getElementById("quickBarcode");
        if (!inp) return;

        let typingTimer;
        const doneTypingDelay = 300; // ms

        
        inp.addEventListener("input", () => {
            clearTimeout(typingTimer);
            const val = inp.value.trim();
            if (!val) return;

            typingTimer = setTimeout(() => {
                handleQuickBarcodeInput(val);
                inp.value = "";
            }, doneTypingDelay);
        });
    })();
    
    // Tombol tambah barang
    document.getElementById("btnTambah")?.addEventListener("click", () => {
        openModal("itemModal");
        document.getElementById("mBarcode").focus();
    });

    // Tombol bayar
    document.getElementById("btnBayar")?.addEventListener("click", () => {
        openPaymentModal();
    });

    // Sync otomatis saat online
    window.addEventListener("online", syncOfflineData);

    // Init awal
    renderCart();
    syncOfflineData();
    focusQuickBarcode();
    clearItemForm()
</script>